<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification - StyleGuard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="src/css/variables.css" rel="stylesheet">
    <link href="src/css/base.css" rel="stylesheet">
    <link href="src/css/components.css" rel="stylesheet">
    <link href="src/css/layout.css" rel="stylesheet">
    <link href="src/css/pages/auth.css" rel="stylesheet">
</head>
<body>
    <div class="auth-container">
        <div class="container-fluid">
            <div class="row justify-content-center align-items-center min-vh-100">
                <div class="col-md-6 col-lg-4">
                    <div class="auth-card">
                        <div class="auth-header">
                            <h2>Email Verification</h2>
                            <p class="text-muted">Verifying your email address...</p>
                        </div>
                        
                        <div class="auth-body">
                            <div id="verificationStatus" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3">Please wait while we verify your email...</p>
                            </div>
                            
                            <div id="verificationResult" class="d-none">
                                <!-- Results will be populated by JavaScript -->
                            </div>
                            
                            <div id="resendSection" class="d-none mt-4">
                                <hr>
                                <div class="text-center">
                                    <p class="small text-muted">Didn't receive the email?</p>
                                    <button type="button" class="btn btn-outline-primary" id="resendBtn">
                                        Resend Verification Email
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="auth-footer">
                            <div class="text-center">
                                <a href="/login.html" class="btn btn-link">Back to Login</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { AuthManager } from './src/js/auth-manager.js';

        class EmailVerification {
            constructor() {
                this.authManager = new AuthManager();
                this.init();
            }

            async init() {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                const email = urlParams.get('email');

                if (token) {
                    await this.verifyEmail(token);
                } else {
                    this.showError('Invalid verification link. No token provided.');
                }

                this.setupEventListeners(email);
            }

            async verifyEmail(token) {
                try {
                    const result = await this.authManager.verifyEmail(token);
                    
                    if (result.success) {
                        this.showSuccess(result.message, result.user);
                    } else {
                        this.showError(result.error);
                        this.showResendSection();
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                    this.showError('An unexpected error occurred during verification.');
                    this.showResendSection();
                }
            }

            showSuccess(message, user) {
                document.getElementById('verificationStatus').classList.add('d-none');
                
                const resultDiv = document.getElementById('verificationResult');
                resultDiv.innerHTML = `
                    <div class="alert alert-success text-center">
                        <i class="bi bi-check-circle-fill fs-1 text-success"></i>
                        <h4 class="mt-3">Email Verified Successfully!</h4>
                        <p>${message}</p>
                        <p class="mb-0">Welcome, ${user?.firstName || 'User'}!</p>
                    </div>
                    <div class="text-center mt-3">
                        <a href="/login.html" class="btn btn-primary">
                            <i class="bi bi-box-arrow-in-right"></i> Sign In Now
                        </a>
                    </div>
                `;
                resultDiv.classList.remove('d-none');
            }

            showError(message) {
                document.getElementById('verificationStatus').classList.add('d-none');
                
                const resultDiv = document.getElementById('verificationResult');
                resultDiv.innerHTML = `
                    <div class="alert alert-danger text-center">
                        <i class="bi bi-exclamation-circle-fill fs-1 text-danger"></i>
                        <h4 class="mt-3">Verification Failed</h4>
                        <p>${message}</p>
                    </div>
                `;
                resultDiv.classList.remove('d-none');
            }

            showResendSection() {
                document.getElementById('resendSection').classList.remove('d-none');
            }

            setupEventListeners(email) {
                const resendBtn = document.getElementById('resendBtn');
                if (resendBtn) {
                    resendBtn.addEventListener('click', async () => {
                        const userEmail = email || prompt('Please enter your email address:');
                        if (userEmail) {
                            await this.resendVerification(userEmail);
                        }
                    });
                }
            }

            async resendVerification(email) {
                const resendBtn = document.getElementById('resendBtn');
                const originalText = resendBtn.textContent;
                
                resendBtn.disabled = true;
                resendBtn.textContent = 'Sending...';

                try {
                    const result = await this.authManager.resendVerificationEmail(email);
                    
                    if (result.success) {
                        this.showAlert(result.message, 'success');
                        resendBtn.textContent = 'Email Sent!';
                        setTimeout(() => {
                            resendBtn.textContent = originalText;
                            resendBtn.disabled = false;
                        }, 3000);
                    } else {
                        this.showAlert(result.error, 'danger');
                        resendBtn.disabled = false;
                        resendBtn.textContent = originalText;
                    }
                } catch (error) {
                    console.error('Resend error:', error);
                    this.showAlert('Failed to resend verification email.', 'danger');
                    resendBtn.disabled = false;
                    resendBtn.textContent = originalText;
                }
            }

            showAlert(message, type = 'info') {
                const existingAlert = document.querySelector('.verification-alert');
                if (existingAlert) {
                    existingAlert.remove();
                }

                const alert = document.createElement('div');
                alert.className = `alert alert-${type} alert-dismissible fade show verification-alert`;
                alert.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                const container = document.querySelector('.auth-body');
                container.insertBefore(alert, container.firstChild);

                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.remove();
                    }
                }, 5000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new EmailVerification();
        });
    </script>
</body>
</html>